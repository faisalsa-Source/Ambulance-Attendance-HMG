<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Dispatcher Dashboard</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
:root {
  --primary: #2563eb;
  --success: #22c55e;
  --danger: #dc2626;
  --bg: #f4f7fb;
  --card-bg: #ffffff;
  --border: #e5e7eb;
  --muted: #6b7280;
}
body {
  margin: 0;
  font-family: system-ui;
  background: var(--bg);
  color: #111;
  display: flex;
  height: 100vh;
}
.sidebar {
  width: 260px;
  background: var(--card-bg);
  border-right: 1px solid var(--border);
  padding: 20px;
  overflow-y: auto;
}
.sidebar h2 {
  color: var(--primary);
}
.main {
  flex: 1;
  padding: 20px;
  overflow: auto;
}
.top-bar {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 20px;
}
.top-bar h1 {
  color: var(--primary);
}
.card {
  background: var(--card-bg);
  border: 1px solid var(--border);
  border-radius: 12px;
  box-shadow: 0 4px 10px rgba(0, 0, 0, 0.05);
  padding: 20px;
  margin-bottom: 20px;
}
table {
  width: 100%;
  border-collapse: collapse;
}
th, td {
  padding: 10px;
  border-bottom: 1px solid var(--border);
  text-align: center;
}
th {
  background: #f3f4f6;
}
tr:nth-child(even) {
  background: #f9fafb;
}
tr:hover {
  background: #eef6ff;
}
.metric {
  display: inline-block;
  margin: 0 10px;
  text-align: center;
}
.metric h3 {
  margin: 0;
  color: var(--muted);
}
.metric p {
  font-size: 20px;
  font-weight: bold;
}
</style>
</head>
<body>

<aside class="sidebar">
  <h2>Stations</h2>
  <ul id="stationList"></ul>
</aside>

<section class="main">
  <div class="top-bar">
    <h1>Dispatcher Dashboard</h1>
    <div class="metric"><h3>Total Stations</h3><p id="metricStations">0</p></div>
    <div class="metric"><h3>ON Duty</h3><p id="metricOn">0</p></div>
    <div class="metric"><h3>OFF Duty</h3><p id="metricOff">0</p></div>
  </div>

  <div class="card">
    <canvas id="dutyChart"></canvas>
  </div>

  <div class="card">
    <table id="dataTable">
      <thead>
        <tr>
          <th>Timestamp</th>
          <th>Station</th>
          <th>Paramedic</th>
          <th>Contact</th>
          <th>ON Duty</th>
          <th>OFF Duty</th>
          <th>Notes</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>
</section>

<script>
const SHEET_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vQPo6YXlwm6bQbf_NJLAp7c4tJiyL0cYBq1ISQfSbYcfy7UqMcJaf4xmQJ_t6cU931s2eex6LjvWP0x/pub?gid=387799263&single=true&output=csv";

async function loadData() {
  try {
    const res = await fetch(SHEET_URL);
    const text = await res.text();
    const rows = text.trim().split("\n").map(r => r.split(","));
    const headers = rows[0];
    const data = rows.slice(1);

    const tbody = document.querySelector("#dataTable tbody");
    tbody.innerHTML = "";

    const stations = new Set();
    let totalOn = 0;
    let totalOff = 0;

    data.forEach(row => {
      const [timestamp, station, name, contact, on, off, notes] = row;
      stations.add(station);
      totalOn += parseInt(on || 0);
      totalOff += parseInt(off || 0);

      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td>${timestamp}</td>
        <td>${station}</td>
        <td>${name}</td>
        <td>${contact}</td>
        <td>${on}</td>
        <td>${off}</td>
        <td>${notes}</td>
      `;
      tbody.appendChild(tr);
    });

    // Update metrics
    document.getElementById("metricStations").textContent = stations.size;
    document.getElementById("metricOn").textContent = totalOn;
    document.getElementById("metricOff").textContent = totalOff;

    // Sidebar stations
    const stationList = document.getElementById("stationList");
    stationList.innerHTML = "";
    [...stations].sort().forEach(st => {
      const li = document.createElement("li");
      li.textContent = st;
      stationList.appendChild(li);
    });

    // Chart
    const ctx = document.getElementById("dutyChart").getContext("2d");
    if (window.chart) window.chart.destroy();
    window.chart = new Chart(ctx, {
      type: "pie",
      data: {
        labels: ["ON Duty", "OFF Duty"],
        datasets: [{
          data: [totalOn, totalOff],
          backgroundColor: ["#22c55e", "#dc2626"]
        }]
      },
      options: { plugins: { legend: { position: "bottom" } } }
    });

  } catch (err) {
    console.error("Failed to load data:", err);
  }
}

loadData();
setInterval(loadData, 60000); // auto-refresh every 1 min
</script>

</body>
</html>
