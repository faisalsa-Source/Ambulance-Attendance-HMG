<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Dispatcher Dashboard ‚Äî Live</title>

<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<!-- PapaParse -->
<script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>

<style>
:root{
  --primary:#2563eb;
  --success:#22c55e;
  --danger:#dc2626;
  --bg:#f4f7fb;
  --card:#ffffff;
  --text:#111;
  --border:#e5e7eb;
}

/* DARK MODE */
.dark{
  --bg:#0f172a;
  --card:#1e293b;
  --text:#f1f5f9;
  --border:#334155;
}

body{
  margin:0;
  font-family:system-ui,Roboto,Arial;
  background:var(--bg);
  color:var(--text);
  display:flex;
  height:100vh;
}

.sidebar{
  width:300px;
  background:var(--card);
  border-right:1px solid var(--border);
  padding:18px;
  display:flex;
  flex-direction:column;
  gap:12px;
  overflow:auto;
}
.sidebar h2{margin:0;color:var(--primary);font-size:18px}

.controls{display:flex;gap:8px}
.controls button{
  padding:8px 10px;border-radius:8px;border:none;
  background:var(--primary);color:#fff;cursor:pointer;
}

.station-item{
  padding:10px;border-radius:8px;
  border:1px solid var(--border);
  background:var(--card);
  cursor:pointer;
}

.main{flex:1;padding:18px;overflow:auto;display:flex;flex-direction:column;gap:14px}

.metric{
  background:var(--card);
  border:1px solid var(--border);
  padding:10px 14px;
  border-radius:10px;
  min-width:120px;
}

.card{
  background:var(--card);
  border:1px solid var(--border);
  border-radius:10px;
  padding:14px;
}

table{
  width:100%;
  border-collapse:collapse;
}
th,td{
  padding:10px;
  border-bottom:1px solid var(--border);
  text-align:center;
}
th{background:#f3f4f6}
.dark th{background:#1e293b}

.refresh-btn{background:var(--primary);color:#fff}
.export-btn{background:#10b981;color:#fff}
.print-btn{background:#f59e0b;color:#fff}
.darkmode-btn{background:#475569;color:#fff}
</style>
</head>
<body>

<aside class="sidebar">
  <h2>Stations</h2>

  <div class="controls">
    <button id="refreshNow" class="refresh-btn">üîÑ Refresh</button>
    <button id="toggleAuto">Auto:10s(ON)</button>
  </div>

  <div class="controls">
    <button id="darkMode" class="darkmode-btn">üåô Dark</button>
    <button id="exportJson" class="export-btn">üì¶ JSON</button>
    <button id="printNight" class="print-btn">üñ® Print</button>
  </div>

  <input id="searchBox" type="search" placeholder="Search stations‚Ä¶" 
         style="padding:8px;border-radius:6px;border:1px solid var(--border)"/>

  <ul id="stationList" style="list-style:none;padding:0;margin:0;display:flex;flex-direction:column;gap:8px"></ul>
</aside>

<main class="main">
  <h1 style="margin:0;color:var(--primary)">Dispatcher Dashboard</h1>

  <div id="lastUpdated" style="margin-bottom:10px;font-size:13px;opacity:.8">Last: --</div>

  <div style="display:flex;gap:12px;flex-wrap:wrap">
    <div class="metric"><h4>Total Stations</h4><p id="totalStations">‚Äî</p></div>
    <div class="metric"><h4>Total ON Duty</h4><p id="totalOn">‚Äî</p></div>
    <div class="metric"><h4>Total OFF Duty</h4><p id="totalOff">‚Äî</p></div>
    <div class="card"><canvas id="pie"></canvas></div>
  </div>

  <div class="card">
    <table id="dataTable">
      <thead>
        <tr>
          <th>Station ID / Event name</th>
          <th>Sign In Time</th>
          <th>Sign Off Time</th>
          <th>ON</th>
          <th>OFF</th>
          <th>Notes</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>
</main>

<script>
/* ---------------- CONFIG ---------------- */
let SHEET_CSV = "https://docs.google.com/spreadsheets/d/e/2PACX-1vTRZysN6b9Ak0KgpGi9gLqGVlCYf4uewuZTF_vJln5p-eYDKW_aa_gqW0Pj5jighw2GcMetdQABCqJN/pub?output=csv";
const AUTO_INTERVAL = 10000;

/* DOM */
const tbody = document.querySelector("#dataTable tbody");
const stationListEl = document.getElementById("stationList");
const totalStationsEl = document.getElementById("totalStations");
const totalOnEl = document.getElementById("totalOn");
const totalOffEl = document.getElementById("totalOff");
const lastUpdatedEl = document.getElementById("lastUpdated");
const searchBox = document.getElementById("searchBox");

let pieChart=null;
let stationsMap = new Map();
let autoOn = true;
let autoTimer=null;

/* DARK MODE SETUP */
if(localStorage.getItem("darkMode")==="1"){
  document.body.classList.add("dark");
}
document.getElementById("darkMode").onclick = ()=>{
  document.body.classList.toggle("dark");
  localStorage.setItem("darkMode", document.body.classList.contains("dark") ? "1" : "0");
};

/* Fetch Google Sheet */
async function fetchSheet(){
  const url = SHEET_CSV + "&_=" + Date.now();
  return new Promise((resolve,reject)=>{
    Papa.parse(url,{
      download:true, header:true, skipEmptyLines:true,
      complete:res=>resolve(res.data),
      error:err=>reject(err)
    });
  });
}

/* Build data map */
function buildStationMap(rows){
  const map = new Map();
  rows.forEach(r=>{
    const station = r["Station ID / Event name"]?.trim() || "Unknown";
    const signIn = r["Sign In Time"]||"";
    const signOff = r["Sign Off Time"]||"";
    const on = parseInt(r["Ambulance ON Duty"]||0);
    const off = parseInt(r["Ambulance OFF Duty"]||0);
    const notes = r["Notes"]||"";

    const entry = {station,signIn,signOff,on,off,notes};
    if(!map.has(station)) map.set(station,[]);
    map.get(station).push(entry);
  });
  return map;
}

/* Render sidebar */
function renderSidebar(map){
  stationListEl.innerHTML="";
  const q = searchBox.value.toLowerCase().trim();
  [...map.keys()].sort().forEach(name=>{
    if(q && !name.toLowerCase().includes(q)) return;
    const li=document.createElement("li");
    li.className="station-item";
    li.textContent=name;
    li.onclick=()=>renderTable(map,name);
    stationListEl.appendChild(li);
  });
}

/* Render table */
function renderTable(map, filter=null){
  tbody.innerHTML="";
  const rows=[];
  for(const [station,arr] of map.entries()){
    const latest = arr[arr.length-1];
    rows.push(latest);
  }
  let display = filter? rows.filter(r=>r.station===filter):rows;
  display.sort((a,b)=>a.station.localeCompare(b.station));

  display.forEach(r=>{
    const tr=document.createElement("tr");
    tr.innerHTML=`
      <td>${r.station}</td>
      <td>${r.signIn}</td>
      <td>${r.signOff}</td>
      <td>${r.on}</td>
      <td>${r.off}</td>
      <td>${r.notes}</td>
    `;
    tbody.appendChild(tr);
  });
}

/* Metrics + Pie */
function updateMetrics(map){
  let totalOn=0, totalOff=0;
  for(const arr of map.values()){
    const latest = arr[arr.length-1];
    totalOn+=latest.on;
    totalOff+=latest.off;
  }

  totalStationsEl.textContent = map.size;
  totalOnEl.textContent = totalOn;
  totalOffEl.textContent = totalOff;

  const ctx=document.getElementById("pie").getContext("2d");
  if(pieChart) pieChart.destroy();
  pieChart=new Chart(ctx,{
    type:"pie",
    data:{
      labels:["ON","OFF"],
      datasets:[{
        data:[totalOn,totalOff],
        backgroundColor:["#22c55e","#dc2626"]
      }]
    }
  });
}

/* Full refresh */
async function refreshAll(){
  const rows = await fetchSheet();
  stationsMap = buildStationMap(rows);
  renderSidebar(stationsMap);
  renderTable(stationsMap);
  updateMetrics(stationsMap);
  lastUpdatedEl.textContent="Last: "+new Date().toLocaleTimeString();
}

/* Auto refresh */
function startAuto(){
  if(autoTimer) clearInterval(autoTimer);
  autoTimer=setInterval(refreshAll,AUTO_INTERVAL);
}
startAuto();

/* Buttons */
document.getElementById("refreshNow").onclick=refreshAll;
document.getElementById("toggleAuto").onclick=function(){
  autoOn=!autoOn;
  if(autoOn){ startAuto(); this.textContent="Auto:10s(ON)"; }
  else { clearInterval(autoTimer); this.textContent="Auto:OFF"; }
};

/* Print night report */
document.getElementById("printNight").onclick=()=>{
  let txt="üöë Night Report\n\n";
  let total=0;
  for(const [station,arr] of stationsMap.entries()){
    const r=arr[arr.length-1];
    total+=r.on;
    txt+=`üè• ${station}\n‚Ä¢ ${r.on} On Duty\n‚Ä¢ Sign-In: ${r.signIn}\n‚Ä¢ Sign-Off: ${r.signOff}\n\n`;
  }
  txt+=`TOTAL ON DUTY: ${total}`;
  const w=window.open("");
  w.document.write(`<pre>${txt}</pre>`);
  w.print();
};

/* JSON export */
document.getElementById("exportJson").onclick=()=>{
  const out=[];
  for(const [station,arr] of stationsMap.entries()){
    out.push(arr[arr.length-1]);
  }
  const blob=new Blob([JSON.stringify(out,null,2)],{type:"application/json"});
  const a=document.createElement("a");
  a.href=URL.createObjectURL(blob);
  a.download="stations.json";
  a.click();
};

/* Search */
searchBox.oninput=()=>renderSidebar(stationsMap);

/* First load */
refreshAll();
</script>
</body>
</html>
