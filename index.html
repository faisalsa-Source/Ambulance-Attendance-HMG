<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Ambulance Dispatch Dashboard</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<style>
    body {
        font-family: Arial, sans-serif;
        margin: 0;
        background: #f5f5f5;
        transition: 0.4s;
    }
    .dark-mode {
        background: #121212;
        color: white;
    }
    header {
        background: #0059ff;
        padding: 15px;
        color: white;
        font-size: 22px;
        font-weight: bold;
        text-align: center;
    }
    .dark-mode header {
        background: #0033aa;
    }
    .controls {
        display: flex;
        gap: 10px;
        padding: 15px;
        justify-content: center;
        background: white;
    }
    .dark-mode .controls {
        background: #1e1e1e;
    }
    button {
        padding: 10px 15px;
        background: #0059ff;
        border: none;
        color: white;
        border-radius: 6px;
        cursor: pointer;
    }
    button:hover { background: #0043c2; }

    .content {
        display: flex;
        height: calc(100vh - 150px);
    }

    .station-list {
        width: 25%;
        background: white;
        padding: 15px;
        overflow-y: auto;
        border-right: 2px solid #ddd;
    }
    .dark-mode .station-list {
        background: #1e1e1e;
        border-color: #333;
    }

    .station {
        padding: 10px;
        margin-bottom: 10px;
        background: #e9f0ff;
        border-radius: 6px;
        cursor: pointer;
        border-left: 5px solid #0059ff;
    }
    .dark-mode .station {
        background: #2c2c2c;
        border-left-color: #4a8bff;
    }

    .dashboard {
        flex: 1;
        padding: 20px;
        overflow-y: auto;
    }

    .card {
        background: white;
        padding: 15px;
        margin-bottom: 15px;
        border-radius: 8px;
    }
    .dark-mode .card {
        background: #1e1e1e;
        border: 1px solid #333;
    }
</style>
</head>

<body>

<header>üöë Ambulance Dispatch Dashboard</header>

<div class="controls">
    <button onclick="refreshData()">Refresh</button>
    <button onclick="toggleAutoRefresh()">Auto Refresh: <span id='autoStatus'>OFF</span></button>
    <button onclick="printReport()">Print Report</button>
    <button onclick="toggleDarkMode()">Dark Mode</button>
</div>

<div class="content">
    <div class="station-list" id="stationList">
        <h3>Stations</h3>
        <p>Loading...</p>
    </div>

    <div class="dashboard" id="dashboardContent">
        <h2>Live Statistics</h2>
        <p>Loading data...</p>
    </div>
</div>

<script>
const SHEET_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vTRZysN6b9Ak0KgpGi9gLqGVlCYf4uewuZTF_vJln5p-eYDKW_aa_gqW0Pj5jighw2GcMetdQABCqJN/pub?output=csv";

let autoRefresh = false;
let interval;

function toggleDarkMode() {
    document.body.classList.toggle("dark-mode");
}

function toggleAutoRefresh() {
    autoRefresh = !autoRefresh;
    document.getElementById("autoStatus").innerText = autoRefresh ? "ON" : "OFF";

    if (autoRefresh) {
        interval = setInterval(refreshData, 15000);
    } else {
        clearInterval(interval);
    }
}

function refreshData() {
    fetch(SHEET_URL)
        .then(res => res.text())
        .then(csv => parseCSV(csv));
}

function parseCSV(csv) {
    const rows = csv.split("\n").map(r => r.split(","));
    const headers = rows.shift();

    const data = rows.map(r => {
        return {
            station: r[0],
            signIn: r[1],
            signOff: r[2],
            onDuty: r[3],
            offDuty: r[4],
            notes: r[5]
        };
    }).filter(x => x.station.trim() !== "");

    updateStations(data);
    updateDashboard(data);
}

function updateStations(data) {
    const container = document.getElementById("stationList");
    container.innerHTML = "<h3>Stations</h3>";

    const uniqueStations = [...new Set(data.map(x => x.station))];

    uniqueStations.forEach(st => {
        const el = document.createElement("div");
        el.className = "station";
        el.innerHTML = `<b>${st}</b>`;
        container.appendChild(el);
    });
}

function updateDashboard(data) {
    const container = document.getElementById("dashboardContent");
    const totalOn = data.filter(x => x.onDuty.trim() !== "").length;

    container.innerHTML = `
        <h2>Live Statistics</h2>
        <div class="card">
            <h3>Total Units On Duty: ${totalOn}</h3>
        </div>
    `;

    data.forEach(row => {
        container.innerHTML += `
            <div class="card">
                <h3>${row.station}</h3>
                <p><b>Sign In:</b> ${row.signIn}</p>
                <p><b>Sign Off:</b> ${row.signOff}</p>
                <p><b>On Duty:</b> ${row.onDuty}</p>
                <p><b>Off Duty:</b> ${row.offDuty}</p>
                <p><b>Notes:</b> ${row.notes}</p>
            </div>
        `;
    });
}

function printReport() {
    fetch(SHEET_URL)
        .then(res => res.text())
        .then(csv => {
            const rows = csv.split("\n").map(r => r.split(","));
            rows.shift();

            let text = `üöë Paramedics for Night ${new Date().toLocaleDateString()}\n\n`;
            text += `‚∏ªüî¥Units On Dutyüî¥‚Äî‚Äî‚Äî\n\n`;

            let total = 0;

            rows.forEach(r => {
                if (r[3].trim() !== "") {
                    text += `üè• ${r[0]}\n‚Ä¢ ${r[3]} : On Duty\n\n`;
                    total++;
                }
            });

            text += `--------------------------\nTOTAL ON DUTY ‚úÖ ${total}`;

            const win = window.open("");
            win.document.write(`<pre>${text}</pre>`);
            win.print();
            win.close();
        });
}

refreshData();
</script>

</body>
</html>
